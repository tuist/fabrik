# Cross.toml - Configuration for cross-compilation
# Install protoc 28.3 (same version as mise config) in all cross Docker images
#
# IMPORTANT: Cross-compilation runs ON x86_64 hosts, so protoc must be x86_64
# even when cross-compiling FOR ARM targets. Protoc runs during build.rs,
# which executes on the host, not the target architecture.
#
# NOTE: We install clang-14 because bindgen 0.72+ requires clang 11+
# (uses clang_Type_getValueType which was added in clang 11).
# The default cross images have clang 10 which is too old.

[build.env]
passthrough = ["PROTOC"]

# All targets use x86_64 protoc because cross builds run on x86_64 hosts
[target.x86_64-unknown-linux-gnu]
pre-build = [
    "apt-get update && apt-get install -y curl unzip wget gnupg software-properties-common",
    "wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -",
    "add-apt-repository 'deb http://apt.llvm.org/focal/ llvm-toolchain-focal-14 main'",
    "apt-get update && apt-get install -y clang-14 libclang-14-dev",
    "ln -sf /usr/bin/clang-14 /usr/bin/clang",
    "curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v28.3/protoc-28.3-linux-x86_64.zip",
    "unzip protoc-28.3-linux-x86_64.zip -d /usr/local",
    "chmod +x /usr/local/bin/protoc",
    "rm protoc-28.3-linux-x86_64.zip",
]

[target.x86_64-unknown-linux-gnu.env]
passthrough = [
    "LIBCLANG_PATH=/usr/lib/llvm-14/lib",
    "LLVM_CONFIG_PATH=/usr/bin/llvm-config-14",
]

[target.x86_64-unknown-linux-musl]
pre-build = [
    "apt-get update && apt-get install -y curl unzip wget gnupg software-properties-common",
    "wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -",
    "add-apt-repository 'deb http://apt.llvm.org/focal/ llvm-toolchain-focal-14 main'",
    "apt-get update && apt-get install -y clang-14 libclang-14-dev",
    "ln -sf /usr/bin/clang-14 /usr/bin/clang",
    "curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v28.3/protoc-28.3-linux-x86_64.zip",
    "unzip protoc-28.3-linux-x86_64.zip -d /usr/local",
    "chmod +x /usr/local/bin/protoc",
    "rm protoc-28.3-linux-x86_64.zip",
]

[target.x86_64-unknown-linux-musl.env]
passthrough = [
    "LIBCLANG_PATH=/usr/lib/llvm-14/lib",
    "LLVM_CONFIG_PATH=/usr/bin/llvm-config-14",
]

[target.aarch64-unknown-linux-gnu]
pre-build = [
    "apt-get update && apt-get install -y curl unzip wget gnupg software-properties-common",
    "wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -",
    "add-apt-repository 'deb http://apt.llvm.org/focal/ llvm-toolchain-focal-14 main'",
    "apt-get update && apt-get install -y clang-14 libclang-14-dev",
    "ln -sf /usr/bin/clang-14 /usr/bin/clang",
    "curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v28.3/protoc-28.3-linux-x86_64.zip",
    "unzip protoc-28.3-linux-x86_64.zip -d /usr/local",
    "chmod +x /usr/local/bin/protoc",
    "rm protoc-28.3-linux-x86_64.zip",
]

[target.aarch64-unknown-linux-gnu.env]
passthrough = [
    "LIBCLANG_PATH=/usr/lib/llvm-14/lib",
    "LLVM_CONFIG_PATH=/usr/bin/llvm-config-14",
]

[target.aarch64-unknown-linux-musl]
pre-build = [
    "apt-get update && apt-get install -y curl unzip wget gnupg software-properties-common",
    "wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -",
    "add-apt-repository 'deb http://apt.llvm.org/focal/ llvm-toolchain-focal-14 main'",
    "apt-get update && apt-get install -y clang-14 libclang-14-dev",
    "ln -sf /usr/bin/clang-14 /usr/bin/clang",
    "curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v28.3/protoc-28.3-linux-x86_64.zip",
    "unzip protoc-28.3-linux-x86_64.zip -d /usr/local",
    "chmod +x /usr/local/bin/protoc",
    "rm protoc-28.3-linux-x86_64.zip",
]

[target.aarch64-unknown-linux-musl.env]
passthrough = [
    "LIBCLANG_PATH=/usr/lib/llvm-14/lib",
    "LLVM_CONFIG_PATH=/usr/bin/llvm-config-14",
]

# ARMv7 targets are disabled because rquickjs doesn't have pre-built bindings for them
# Uncomment when/if rquickjs adds armv7 support
# [target.armv7-unknown-linux-gnueabihf]
# [target.armv7-unknown-linux-musleabihf]
